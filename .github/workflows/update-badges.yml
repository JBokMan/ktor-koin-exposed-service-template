name: Update Dependency Badges

on:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-badges:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 1

      - name: Extract Dependency Versions
        id: extract_versions
        run: |
          KOTLIN_VERSION=$(grep 'kotlin-version = ' gradle/libs.versions.toml | cut -d'"' -f2)
          KTOR_VERSION=$(grep 'ktor-version = ' gradle/libs.versions.toml | cut -d'"' -f2)
          KOIN_VERSION=$(grep 'koin-version = ' gradle/libs.versions.toml | cut -d'"' -f2)
          EXPOSED_VERSION=$(grep 'exposed-version = ' gradle/libs.versions.toml | cut -d'"' -f2)

          echo "KOTLIN_VERSION=$KOTLIN_VERSION" >> $GITHUB_ENV
          echo "KTOR_VERSION=$KTOR_VERSION" >> $GITHUB_ENV
          echo "KOIN_VERSION=$KOIN_VERSION" >> $GITHUB_ENV
          echo "EXPOSED_VERSION=$EXPOSED_VERSION" >> $GITHUB_ENV

      - name: Update README Badges
        run: |
          sed -i "s|Kotlin-[0-9.]*-blue|Kotlin-$KOTLIN_VERSION-blue|g" README.md
          sed -i "s|Ktor-[0-9.]*-blue|Ktor-$KTOR_VERSION-blue|g" README.md
          sed -i "s|Koin-[0-9.]*-blue|Koin-$KOIN_VERSION-blue|g" README.md
          sed -i "s|Exposed-[0-9.]*-blue|Exposed-$EXPOSED_VERSION-blue|g" README.md

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: ðŸªª update badges in README.md
          title: ðŸªª Update dependency badges in README
          body: |
            Automated badge update:
            - Kotlin: ${{ env.KOTLIN_VERSION }}
            - Ktor: ${{ env.KTOR_VERSION }}
            - Koin: ${{ env.KOIN_VERSION }}
            - Exposed: ${{ env.EXPOSED_VERSION }}
          branch: chore/update-badges
          delete-branch: true

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
